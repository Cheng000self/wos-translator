<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统设置 - WoS Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
    <nav class="fixed top-4 left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-200 rounded-2xl shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span class="text-xl font-bold text-slate-900">WoS Translator</span>
                    </div>
                    <a href="/donate.html" class="text-pink-600 hover:text-pink-700 transition-colors cursor-pointer flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span>捐赠</span>
                    </a>
                </div>
                <div class="flex space-x-6">
                    <a href="/" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">主页</a>
                    <a href="/translate.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">翻译</a>
                    <a href="/queue.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">队列</a>
                    <a href="/convert.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">转换</a>
                    <a href="/models.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">模型</a>
                    <a href="/settings.html" class="text-blue-600 font-medium hover:text-blue-700 transition-colors cursor-pointer">设置</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-28 pb-12 px-4">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-slate-900 mb-8">系统设置</h1>

            <div id="passwordVerify" class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold text-slate-900 mb-4">密码验证</h2>
                <p class="text-slate-600 mb-4">请输入管理员密码以访问设置</p>
                <div class="flex space-x-2">
                    <input type="password" id="password" placeholder="密码" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                    <button id="verifyBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
                        验证
                    </button>
                </div>
            </div>

            <div id="settingsForm" class="hidden space-y-6">
                <!-- 存储管理 -->
                <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-slate-900 mb-6">存储管理</h2>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-900">存储使用量</p>
                                <p id="storageUsage" class="text-slate-600">加载中...</p>
                            </div>
                            <button id="refreshStorage" class="px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-900">已删除任务</p>
                                <p id="deletedCount" class="text-slate-600">加载中...</p>
                            </div>
                            <button id="cleanupBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors cursor-pointer">
                                永久删除
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-900">清理旧任务</p>
                                <p class="text-slate-600">删除除今天以外的所有任务（不可恢复）</p>
                            </div>
                            <button id="cleanupOldBtn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors cursor-pointer">
                                清理旧任务
                            </button>
                        </div>
                        <div class="flex items-center justify-between p-4 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-medium text-slate-900">日志文件</p>
                                <p id="logSize" class="text-slate-600">加载中...</p>
                            </div>
                            <div class="flex space-x-2">
                                <button id="archiveLogBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer text-sm">
                                    归档
                                </button>
                                <button id="clearLogsBtn" class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors cursor-pointer text-sm">
                                    清理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 日志管理 -->
                <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-slate-900 mb-6">日志管理</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">日志管理模式</label>
                            <div class="flex space-x-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="logManageMode" value="0" class="w-4 h-4 text-blue-600 cursor-pointer" checked>
                                    <span class="text-slate-700">定时删除</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="radio" name="logManageMode" value="1" class="w-4 h-4 text-blue-600 cursor-pointer">
                                    <span class="text-slate-700">定时归档</span>
                                </label>
                            </div>
                            <p class="text-xs text-slate-500 mt-1">定时删除：自动删除过期日志；定时归档：按日期归档日志文件</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div id="retentionDaysGroup">
                                <label class="block text-sm font-medium text-slate-700 mb-2">日志保留天数</label>
                                <input type="number" id="logRetentionDays" min="1" max="365" class="w-full px-4 py-2 border rounded-lg">
                                <p class="text-xs text-slate-500 mt-1">超过此天数的日志将被自动删除</p>
                            </div>
                            <div id="archiveIntervalGroup" class="hidden">
                                <label class="block text-sm font-medium text-slate-700 mb-2">归档间隔天数</label>
                                <input type="number" id="logArchiveIntervalDays" min="1" max="365" class="w-full px-4 py-2 border rounded-lg">
                                <p class="text-xs text-slate-500 mt-1">每隔此天数自动归档当前日志</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 系统参数 -->
                <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-slate-900 mb-6">系统参数</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">每任务最大上传文件数</label>
                            <input type="number" id="maxUploadFiles" min="1" max="100" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">单个任务可上传的HTML文件数量</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">最大任务数</label>
                            <input type="number" id="maxTasks" min="1" max="1000" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">系统最大任务数量</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">最大并发任务数</label>
                            <input type="number" id="maxConcurrentTasks" min="1" max="10" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">同时执行的任务数量上限</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">同模型最大并发任务数</label>
                            <input type="number" id="maxConcurrentTasksPerModel" min="1" max="10" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">使用同一模型的任务并发数</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">翻译线程数</label>
                            <input type="number" id="maxTranslationThreads" min="1" max="16" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">单模型最大并行翻译线程数</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">单任务最大模型数</label>
                            <input type="number" id="maxModelsPerTask" min="1" max="20" class="w-full px-4 py-2 border rounded-lg">
                            <p class="text-xs text-slate-500 mt-1">单个翻译任务可使用的最大模型数量</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">日志级别</label>
                            <select id="logLevel" class="w-full px-4 py-2 border rounded-lg cursor-pointer">
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 修改密码 -->
                <div class="bg-white rounded-xl p-8 shadow-sm border border-gray-200">
                    <h2 class="text-xl font-semibold text-slate-900 mb-6">修改密码</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">当前密码</label>
                            <input type="password" id="oldPassword" class="w-full px-4 py-2 border rounded-lg" placeholder="留空表示不修改密码">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-2">新密码</label>
                            <input type="password" id="newPassword" class="w-full px-4 py-2 border rounded-lg" placeholder="至少6个字符">
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button id="saveSettings" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="/assets/js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 检查会话
            if (isAuthenticated()) {
                showSettings();
            }

            document.getElementById('verifyBtn').addEventListener('click', verifyPassword);
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') verifyPassword();
            });
            document.getElementById('saveSettings').addEventListener('click', saveSettings);
            document.getElementById('refreshStorage').addEventListener('click', loadStorageInfo);
            document.getElementById('cleanupBtn').addEventListener('click', cleanupDeleted);
            document.getElementById('cleanupOldBtn').addEventListener('click', cleanupOldTasks);
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('archiveLogBtn').addEventListener('click', archiveLog);
            
            // 日志管理模式切换
            document.querySelectorAll('input[name="logManageMode"]').forEach(radio => {
                radio.addEventListener('change', toggleLogManageMode);
            });
        });

        async function verifyPassword() {
            const password = document.getElementById('password').value;
            if (!password) {
                showToast('请输入密码', 'warning');
                return;
            }

            try {
                const result = await apiCall('POST', '/api/settings/verify', { password });
                if (result.success && result.token) {
                    // 保存会话token
                    setSessionToken(result.token);
                    showSettings();
                } else {
                    showToast('密码错误', 'error');
                }
            } catch (error) {
                if (error.message.includes('locked') || error.message.includes('Too many')) {
                    showToast('登录尝试次数过多，请稍后再试', 'error');
                } else {
                    showToast('密码错误', 'error');
                }
            }
        }

        async function showSettings() {
            document.getElementById('passwordVerify').classList.add('hidden');
            document.getElementById('settingsForm').classList.remove('hidden');

            try {
                const settings = await apiCall('GET', '/api/settings');
                document.getElementById('maxUploadFiles').value = settings.maxUploadFiles;
                document.getElementById('maxTasks').value = settings.maxTasks;
                document.getElementById('maxConcurrentTasks').value = settings.maxConcurrentTasks;
                document.getElementById('maxConcurrentTasksPerModel').value = settings.maxConcurrentTasksPerModel || 1;
                document.getElementById('maxTranslationThreads').value = settings.maxTranslationThreads || 1;
                document.getElementById('maxModelsPerTask').value = settings.maxModelsPerTask || 5;
                document.getElementById('logLevel').value = settings.logLevel;
                
                // 日志管理配置
                const logManageMode = settings.logManageMode || 0;
                document.querySelector(`input[name="logManageMode"][value="${logManageMode}"]`).checked = true;
                document.getElementById('logRetentionDays').value = settings.logRetentionDays || 7;
                document.getElementById('logArchiveIntervalDays').value = settings.logArchiveIntervalDays || 30;
                toggleLogManageMode();
                
                // 加载存储信息
                loadStorageInfo();
            } catch (error) {
                showToast('加载设置失败: ' + error.message, 'error');
            }
        }

        async function loadStorageInfo() {
            try {
                // 获取存储使用量
                const usage = await apiCall('GET', '/api/storage/usage');
                document.getElementById('storageUsage').textContent = usage.formatted;
                
                // 获取已删除任务数量
                const deleted = await apiCall('GET', '/api/storage/deleted');
                document.getElementById('deletedCount').textContent = `${deleted.count} 个任务待清理`;
                
                // 获取日志大小
                const logs = await apiCall('GET', '/api/logs/size');
                document.getElementById('logSize').textContent = `${logs.formatted} (${logs.fileCount} 个文件)`;
            } catch (error) {
                console.error('Failed to load storage info:', error);
            }
        }

        async function clearLogs() {
            if (!confirm('确定要清理所有日志文件吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const result = await apiCall('POST', '/api/logs/clear');
                showToast(`已清理 ${result.deletedCount} 个日志文件`, 'success');
                loadStorageInfo();
            } catch (error) {
                showToast('清理失败: ' + error.message, 'error');
            }
        }
        
        async function archiveLog() {
            try {
                const result = await apiCall('POST', '/api/logs/archive');
                if (result.success) {
                    showToast('日志已归档', 'success');
                } else {
                    showToast(result.message || '没有日志需要归档', 'info');
                }
                loadStorageInfo();
            } catch (error) {
                showToast('归档失败: ' + error.message, 'error');
            }
        }
        
        function toggleLogManageMode() {
            const mode = document.querySelector('input[name="logManageMode"]:checked').value;
            const retentionGroup = document.getElementById('retentionDaysGroup');
            const archiveGroup = document.getElementById('archiveIntervalGroup');
            
            if (mode === '0') {
                // 定时删除模式
                retentionGroup.classList.remove('hidden');
                archiveGroup.classList.add('hidden');
            } else {
                // 定时归档模式
                retentionGroup.classList.add('hidden');
                archiveGroup.classList.remove('hidden');
            }
        }

        async function cleanupDeleted() {
            if (!confirm('确定要永久删除所有已删除的任务吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const result = await apiCall('POST', '/api/storage/cleanup');
                showToast(`已永久删除 ${result.deletedCount} 个任务`, 'success');
                loadStorageInfo();
            } catch (error) {
                showToast('清理失败: ' + error.message, 'error');
            }
        }

        async function cleanupOldTasks() {
            if (!confirm('确定要删除除今天以外的所有任务吗？此操作不可恢复！')) {
                return;
            }
            
            try {
                const result = await apiCall('POST', '/api/storage/cleanup-old');
                showToast(`已删除 ${result.deletedCount} 个旧任务（保留今天: ${result.today}）`, 'success');
                loadStorageInfo();
            } catch (error) {
                showToast('清理失败: ' + error.message, 'error');
            }
        }

        async function saveSettings() {
            try {
                const data = {
                    maxUploadFiles: parseInt(document.getElementById('maxUploadFiles').value),
                    maxTasks: parseInt(document.getElementById('maxTasks').value),
                    maxConcurrentTasks: parseInt(document.getElementById('maxConcurrentTasks').value),
                    maxConcurrentTasksPerModel: parseInt(document.getElementById('maxConcurrentTasksPerModel').value),
                    maxTranslationThreads: parseInt(document.getElementById('maxTranslationThreads').value),
                    maxModelsPerTask: parseInt(document.getElementById('maxModelsPerTask').value),
                    logLevel: document.getElementById('logLevel').value,
                    logManageMode: parseInt(document.querySelector('input[name="logManageMode"]:checked').value),
                    logRetentionDays: parseInt(document.getElementById('logRetentionDays').value),
                    logArchiveIntervalDays: parseInt(document.getElementById('logArchiveIntervalDays').value)
                };
                
                // 如果要修改密码
                const oldPassword = document.getElementById('oldPassword')?.value;
                const newPassword = document.getElementById('newPassword')?.value;
                if (oldPassword && newPassword) {
                    data.oldPassword = oldPassword;
                    data.newPassword = newPassword;
                }
                
                await apiCall('PUT', '/api/settings', data);
                showToast('保存成功', 'success');
                
                // 如果修改了密码，清空密码字段
                if (oldPassword && newPassword) {
                    document.getElementById('oldPassword').value = '';
                    document.getElementById('newPassword').value = '';
                }
            } catch (error) {
                showToast('保存失败: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>
