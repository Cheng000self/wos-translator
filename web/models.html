<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>模型管理 - WoS Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen">
    <nav class="fixed top-4 left-4 right-4 bg-white/90 backdrop-blur-md border border-gray-200 rounded-2xl shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-2">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
                        </svg>
                        <span class="text-xl font-bold text-slate-900">WoS Translator</span>
                    </div>
                    <a href="/donate.html" class="text-pink-600 hover:text-pink-700 transition-colors cursor-pointer flex items-center space-x-1">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <span>捐赠</span>
                    </a>
                </div>
                <div class="flex space-x-6">
                    <a href="/" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">主页</a>
                    <a href="/translate.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">翻译</a>
                    <a href="/queue.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">队列</a>
                    <a href="/convert.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">转换</a>
                    <a href="/models.html" class="text-blue-600 font-medium hover:text-blue-700 transition-colors cursor-pointer">模型</a>
                    <a href="/settings.html" class="text-slate-600 hover:text-slate-900 transition-colors cursor-pointer">设置</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="pt-28 pb-12 px-4">
        <div class="max-w-4xl mx-auto">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-3xl font-bold text-slate-900">模型管理</h1>
                <button id="addModel" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors cursor-pointer">
                    添加模型
                </button>
            </div>

            <div id="modelList" class="space-y-4">
                <div class="text-center py-12 text-slate-500">加载中...</div>
            </div>
        </div>
    </div>

    <script src="/assets/js/common.js"></script>
    <script>
        let models = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadModels();
            document.getElementById('addModel').addEventListener('click', showModelForm);
        });

        async function loadModels() {
            try {
                models = await apiCall('GET', '/api/models');
                renderModels();
            } catch (error) {
                showToast('加载失败: ' + error.message, 'error');
            }
        }

        function renderModels() {
            const list = document.getElementById('modelList');
            if (models.length === 0) {
                list.innerHTML = '<div class="text-center py-12 text-slate-500">暂无模型配置</div>';
                return;
            }

            list.innerHTML = models.map(model => `
                <div class="bg-white rounded-xl p-6 shadow-sm border border-gray-200">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-slate-900 mb-2">${model.name}</h3>
                            <p class="text-sm text-slate-600">模型: ${model.modelId}</p>
                            <p class="text-sm text-slate-600">温度: ${model.temperature}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="showModelDetails('${model.id}')" class="px-3 py-1.5 text-sm text-blue-600 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer" title="查看详情">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                            <button onclick="testModel('${model.id}')" class="px-3 py-1.5 text-sm text-green-600 hover:bg-green-50 rounded-lg transition-colors cursor-pointer" title="测试连接">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteModel('${model.id}')" class="px-3 py-1.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition-colors cursor-pointer" title="删除">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function showModelDetails(id) {
            const model = models.find(m => m.id === id);
            if (!model) return;

            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-lg w-full max-h-[80vh] overflow-y-auto">
                    <h2 class="text-xl font-bold text-slate-900 mb-4">模型详情</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">名称</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg">${model.name}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">API URL</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg break-all">${model.url}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">API Key</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg font-mono text-sm">${model.apiKey.substring(0, 8)}...${model.apiKey.substring(model.apiKey.length - 4)}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">模型ID</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg">${model.modelId}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">温度</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg">${model.temperature}</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">系统提示词</label>
                            <p class="text-slate-900 bg-slate-50 px-3 py-2 rounded-lg text-sm whitespace-pre-wrap">${model.systemPrompt}</p>
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button class="close-btn px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 cursor-pointer">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('.close-btn').addEventListener('click', () => overlay.remove());
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) overlay.remove();
            });
        }

        async function testModel(id) {
            const model = models.find(m => m.id === id);
            if (!model) return;

            showLoading('正在测试连接...');
            try {
                const result = await apiCall('POST', '/api/models/test', {
                    url: model.url,
                    apiKey: model.apiKey,
                    modelId: model.modelId,
                    temperature: model.temperature,
                    systemPrompt: model.systemPrompt
                });
                hideLoading();
                if (result.success) {
                    showToast('连接测试成功！模型可正常使用', 'success');
                } else {
                    showToast('连接测试失败: ' + (result.error || '未知错误'), 'error');
                }
            } catch (error) {
                hideLoading();
                showToast('连接测试失败: ' + error.message, 'error');
            }
        }

        function showModelForm() {
            const overlay = document.createElement('div');
            overlay.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            overlay.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full">
                    <h2 class="text-xl font-bold text-slate-900 mb-4">添加模型</h2>
                    <div class="space-y-4">
                        <input type="text" id="modelName" placeholder="模型名称" class="w-full px-4 py-2 border rounded-lg">
                        <input type="text" id="modelUrl" placeholder="API URL" class="w-full px-4 py-2 border rounded-lg">
                        <input type="password" id="modelApiKey" placeholder="API Key" class="w-full px-4 py-2 border rounded-lg">
                        <input type="text" id="modelId" placeholder="模型ID (如 gpt-4)" class="w-full px-4 py-2 border rounded-lg">
                        <input type="number" id="modelTemp" placeholder="温度 (0-2)" value="0.3" step="0.1" class="w-full px-4 py-2 border rounded-lg">
                    </div>
                    <div class="flex justify-end space-x-2 mt-6">
                        <button class="cancel-btn px-4 py-2 text-slate-600 hover:bg-slate-100 rounded-lg cursor-pointer">取消</button>
                        <button class="save-btn px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer">保存</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);

            overlay.querySelector('.cancel-btn').addEventListener('click', () => overlay.remove());
            overlay.querySelector('.save-btn').addEventListener('click', async () => {
                try {
                    await apiCall('POST', '/api/models', {
                        name: document.getElementById('modelName').value,
                        url: document.getElementById('modelUrl').value,
                        apiKey: document.getElementById('modelApiKey').value,
                        modelId: document.getElementById('modelId').value,
                        temperature: parseFloat(document.getElementById('modelTemp').value)
                    });
                    overlay.remove();
                    showToast('保存成功', 'success');
                    loadModels();
                } catch (error) {
                    showToast('保存失败: ' + error.message, 'error');
                }
            });
        }

        async function deleteModel(id) {
            showConfirm('确定要删除这个模型吗？', async () => {
                try {
                    await apiCall('DELETE', `/api/models/${id}`);
                    showToast('删除成功', 'success');
                    loadModels();
                } catch (error) {
                    showToast('删除失败: ' + error.message, 'error');
                }
            });
        }
    </script>
</body>
</html>
